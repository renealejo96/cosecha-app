{% extends "base.html" %}

{% block title %}Nuevo Registro de Cosecha{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Nuevo Registro de Cosecha
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" id="registroForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">
                                <i class="fas fa-calendar me-1"></i>
                                Fecha *
                            </label>
                            <input type="date" class="form-control" id="fecha" name="fecha" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="viaje" class="form-label">
                                <i class="fas fa-truck me-1"></i>
                                Viaje *
                            </label>
                            <input type="text" class="form-control" id="viaje" name="viaje" 
                                   placeholder="Ingrese el número o nombre del viaje" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="semana" class="form-label">
                                <i class="fas fa-calendar-week me-1"></i>
                                Semana *
                            </label>
                            <input type="number" class="form-control" id="semana" name="semana" 
                                   min="1" max="53" placeholder="1-53" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tallos" class="form-label">
                                <i class="fas fa-leaf me-1"></i>
                                Tallos *
                            </label>
                            <select class="form-select" id="tallos" name="tallos" required>
                                <option value="">Seleccione cantidad de tallos</option>
                                <option value="10">10 tallos</option>
                                <option value="15">15 tallos</option>
                                <option value="25">25 tallos</option>
                                <option value="30">30 tallos</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mallas" class="form-label">
                                <i class="fas fa-th me-1"></i>
                                Mallas *
                            </label>
                            <input type="number" class="form-control" id="mallas" name="mallas" 
                                   min="1" placeholder="Número de mallas" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modulo" class="form-label">
                                <i class="fas fa-cube me-1"></i>
                                Módulo *
                            </label>
                            <select class="form-select" id="modulo" name="modulo" required>
                                <option value="">Seleccione un módulo</option>
                                {% for mod in modulos %}
                                <option value="{{ mod }}">{{ mod }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Módulos cargados desde modulos.csv
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="variedad" class="form-label">
                                <i class="fas fa-seedling me-1"></i>
                                Variedad *
                            </label>
                            <select class="form-select" id="variedad" name="variedad" required>
                                <option value="">Seleccione una variedad</option>
                                {% for var in variedades %}
                                <option value="{{ var }}">{{ var }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Variedades cargadas desde variedades.csv
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="responsable" class="form-label">
                                <i class="fas fa-user me-1"></i>
                                Responsable *
                            </label>
                            <select class="form-select" id="responsable" name="responsable" required>
                                <option value="">Seleccione un responsable</option>
                                {% for resp in responsables %}
                                <option value="{{ resp }}">{{ resp }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Responsables cargados desde responsables.csv
                            </small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calculator me-1"></i>
                                Total de Tallos
                            </label>
                            <input type="text" class="form-control" id="totalTallos" readonly 
                                   placeholder="Se calculará automáticamente">
                            <small class="form-text text-muted">
                                Se calcula automáticamente: Tallos × Mallas
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-clock me-1"></i>
                                Hora de Registro
                            </label>
                            <input type="text" class="form-control" id="horaActual" readonly>
                            <small class="form-text text-muted">
                                Se registra automáticamente al momento de guardar
                            </small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>
                            Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Función para actualizar la hora actual
    function actualizarHora() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('horaActual').value = timeString;
    }

    // Función para calcular el total de tallos
    function calcularTotal() {
        const tallos = parseInt(document.getElementById('tallos').value) || 0;
        const mallas = parseInt(document.getElementById('mallas').value) || 0;
        const total = tallos * mallas;
        
        document.getElementById('totalTallos').value = total > 0 ? total : '';
    }

    // Establecer fecha actual por defecto
    document.getElementById('fecha').valueAsDate = new Date();

    // Actualizar hora cada segundo
    actualizarHora();
    setInterval(actualizarHora, 1000);

    // Eventos para calcular total automáticamente
    document.getElementById('tallos').addEventListener('change', calcularTotal);
    document.getElementById('mallas').addEventListener('input', calcularTotal);

    // Validación del formulario
    document.getElementById('registroForm').addEventListener('submit', function(e) {
        const tallos = document.getElementById('tallos').value;
        const mallas = document.getElementById('mallas').value;
        
        if (!tallos || !mallas) {
            e.preventDefault();
            alert('Por favor, complete todos los campos obligatorios.');
            return false;
        }
        
        if (parseInt(mallas) <= 0) {
            e.preventDefault();
            alert('El número de mallas debe ser mayor que 0.');
            return false;
        }
    });
</script>
{% endblock %}