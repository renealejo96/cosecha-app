{% extends "base.html" %}

{% block title %}Nuevo Registro de Cosecha{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Nuevo Registro de Cosecha
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" id="registroForm">
                    <!-- Fecha y Semana -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">
                                <i class="fas fa-calendar me-1"></i>
                                Fecha *
                            </label>
                            <input type="date" class="form-control" id="fecha" name="fecha" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="semana" class="form-label">
                                <i class="fas fa-calendar-week me-1"></i>
                                Semana (Automático)
                            </label>
                            <input type="number" class="form-control bg-light" id="semana" name="semana" 
                                   min="1" max="53" readonly required>
                        </div>
                    </div>

                    <!-- Responsable y Viaje -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="responsable" class="form-label">
                                <i class="fas fa-user me-1"></i>
                                Responsable *
                            </label>
                            <select class="form-select" id="responsable" name="responsable" required>
                                <option value="">Seleccione un responsable</option>
                                {% for resp in responsables %}
                                <option value="{{ resp }}">{{ resp }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="viaje" class="form-label">
                                <i class="fas fa-truck me-1"></i>
                                Viaje *
                            </label>
                            <select class="form-select" id="viaje" name="viaje" required>
                                <option value="">Seleccione el viaje</option>
                                {% for i in range(1, 18) %}
                                <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Módulo y Variedad -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modulo" class="form-label">
                                <i class="fas fa-cube me-1"></i>
                                Módulo *
                            </label>
                            <select class="form-select" id="modulo" name="modulo" required>
                                <option value="">Seleccione un módulo</option>
                                {% for mod in modulos %}
                                <option value="{{ mod }}">{{ mod }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="variedad" class="form-label">
                                <i class="fas fa-seedling me-1"></i>
                                Variedad *
                            </label>
                            <select class="form-select" id="variedad" name="variedad" required>
                                <option value="">Seleccione una variedad</option>
                                {% for var in variedades %}
                                <option value="{{ var }}">{{ var }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Mallas y Tallos -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="mallas" class="form-label">
                                <i class="fas fa-th me-1"></i>
                                Mallas *
                            </label>
                            <input type="number" class="form-control" id="mallas" name="mallas" 
                                   min="1" placeholder="Número de mallas" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tallos" class="form-label">
                                <i class="fas fa-leaf me-1"></i>
                                Tallos *
                            </label>
                            <select class="form-select" id="tallos" name="tallos" required>
                                <option value="">Seleccione cantidad de tallos</option>
                                <option value="10">10 tallos</option>
                                <option value="15">15 tallos</option>
                                <option value="25">25 tallos</option>
                                <option value="30">30 tallos</option>
                            </select>
                        </div>
                    </div>

                    <!-- Total de Tallos - DESTACADO -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-success shadow-sm">
                                <div class="card-body text-center py-4" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                                    <h5 class="card-title text-success mb-2">
                                        <i class="fas fa-calculator me-2"></i>
                                        TOTAL DE TALLOS
                                    </h5>
                                    <h1 class="display-2 fw-bold text-success mb-0" id="totalTallos" style="font-size: 4.5rem;">0</h1>
                                    <small class="text-muted">Tallos × Mallas</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hora de Registro -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="alert alert-secondary">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Hora de registro:</strong> <span id="horaActual"></span> (se guardará automáticamente)
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>
                            Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Función para calcular la semana ISO
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // Función para actualizar la semana basada en la fecha seleccionada
    function actualizarSemana() {
        const fechaInput = document.getElementById('fecha');
        if (fechaInput.value) {
            const fecha = new Date(fechaInput.value + 'T00:00:00');
            const semana = getWeekNumber(fecha);
            document.getElementById('semana').value = semana;
        }
    }

    // Función para actualizar la hora actual en Ecuador
    function actualizarHora() {
        const now = new Date();
        const ecuadorOffset = -5 * 60; // Ecuador está en UTC-5
        const localOffset = now.getTimezoneOffset();
        const ecuadorTime = new Date(now.getTime() + (localOffset + ecuadorOffset) * 60000);
        
        const hours = String(ecuadorTime.getHours()).padStart(2, '0');
        const minutes = String(ecuadorTime.getMinutes()).padStart(2, '0');
        const seconds = String(ecuadorTime.getSeconds()).padStart(2, '0');
        const timeString = `${hours}:${minutes}:${seconds}`;
        
        document.getElementById('horaActual').textContent = timeString;
    }

    // Función para calcular el total de tallos
    function calcularTotal() {
        const tallos = parseInt(document.getElementById('tallos').value) || 0;
        const mallas = parseInt(document.getElementById('mallas').value) || 0;
        const total = tallos * mallas;
        
        document.getElementById('totalTallos').textContent = total > 0 ? total.toLocaleString() : '0';
    }

    // Establecer fecha actual por defecto usando hora de Ecuador (UTC-5)
    const now = new Date();
    const ecuadorOffset = -5 * 60; // Ecuador está en UTC-5
    const localOffset = now.getTimezoneOffset();
    const ecuadorTime = new Date(now.getTime() + (localOffset + ecuadorOffset) * 60000);
    
    const year = ecuadorTime.getFullYear();
    const month = String(ecuadorTime.getMonth() + 1).padStart(2, '0');
    const day = String(ecuadorTime.getDate()).padStart(2, '0');
    const fechaEcuador = `${year}-${month}-${day}`;
    
    document.getElementById('fecha').value = fechaEcuador;
    
    // Calcular semana inicial
    actualizarSemana();

    // Actualizar semana cuando cambie la fecha
    document.getElementById('fecha').addEventListener('change', actualizarSemana);

    // Actualizar hora cada segundo
    actualizarHora();
    setInterval(actualizarHora, 1000);

    // Eventos para calcular total automáticamente
    document.getElementById('tallos').addEventListener('change', calcularTotal);
    document.getElementById('mallas').addEventListener('input', calcularTotal);

    // Validación del formulario
    document.getElementById('registroForm').addEventListener('submit', function(e) {
        const tallos = document.getElementById('tallos').value;
        const mallas = document.getElementById('mallas').value;
        
        if (!tallos || !mallas) {
            e.preventDefault();
            alert('Por favor, complete todos los campos obligatorios.');
            return false;
        }
        
        if (parseInt(mallas) <= 0) {
            e.preventDefault();
            alert('El número de mallas debe ser mayor que 0.');
            return false;
        }
    });
</script>
{% endblock %}